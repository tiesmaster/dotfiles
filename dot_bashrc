. ~/.bashrc.d/bash-history
. ~/.bashrc.d/homebrew
. ~/.bashrc.d/direnv
. ~/.bashrc.d/chezmoi
. ~/.bashrc.d/directory-navigation
. ~/.bashrc.d/starship
. ~/.bashrc.d/golang

. ~/.bashrc.d/k8s
[[ -f ~/.bashrc.d/guida ]] && . ~/.bashrc.d/guida

# Set env vars
export PATH=~/bin:~/.local/bin:~/go/bin:${PATH}
export EDITOR=vim
export LESS="--ignore-case --quit-if-one-screen --long-prompt --raw-control-chars"

# Force config home to be at .config, instead of "~/Library/Application Support/..."
# TODO: Make this conditionally based on OSX
export XDG_CONFIG_HOME=~/.config

# Ensure that K9s reads the config on OSX from the same place as how that works on linux
# TODO: Check if this can go now that we have $XDG_CONFIG_HOME set
export K9S_CONFIG_DIR=~/.config/k9s

# Tell Terraform to share the provider plugins, saves 20 gigs
export TF_PLUGIN_CACHE_DIR="$HOME/.terraform.d/plugin-cache"

# export DOTFILES_START_KUBIE_SUBSHELL_IMMEDIATELY=1

# Aliases

# aliases: general aliases
alias c='code .'

# aliases: linux sysadmin
alias l='ls -CF'
alias ls='ls -hFG --color=auto'
alias la='ls -A'
alias ll='ls -alF'

alias grep='grep --colour=auto'

alias df='df -h'
alias du='du -h'
alias dus='du -s'
alias du1='du --max-depth=1'

# aliases: meta: manage bash
alias eb='czew ~/.bashrc'
alias ek9s='czew ~/.config/k9s/hotkeys.yaml'
alias sb='. ~/.bashrc'

# aliases: git
alias gs='git status'
alias gb='git branch'
alias ga='git ca'
alias gd='git diff'

# aliases: lazy*
alias lzd='lazydocker'
alias lzg='lazygit'

# aliases: tailscale
alias ts=tailscale
alias tss='tailscale status'
alias tsp='tailscale ping'
alias tsh='tailscale ssh'

alias ts-enable-dns='tailscale up --accept-dns=true --accept-routes'
alias ts-disable-dns='tailscale up --accept-dns=false --accept-routes'

# 1Password
alias ops='op signin'

# aliases: docker compose
alias dc='docker compose'

# aliases: terraform
alias tf=terraform
alias tff='terraform fmt'
alias tfv='terraform validate'
alias tfr='terraform refresh'
alias tfp='terraform plan'
alias tfa='terraform apply'
alias tfd='terraform destroy'
alias tfyolo='terraform apply -auto-approve'
alias tfi='terraform init'
alias tfiu='terraform init -upgrade'
alias tfsp='terraform state pull'
alias tfspp='terraform state pull |less'
alias tfspc='terraform state pull |code - '

# aliases: azure
alias azl-set-default='az account set --subscription "$(az account list --query "[].name" --output tsv | fzf)"'

# aliases: minikube
alias mk=minikube
alias mks='minikube start'
alias mkd='minikube delete'

# aliases: personal projects
alias backup-golink='curl -s http://go/.export >~/tmp/backup/golink_`date +%F_%H-%M-%S`.jsonl'

alias ho='cd ~/src/private/homeops/'
alias tfc='cd ~/src/private/tfcleanup/'

# aliases: misc
alias r2='vlc ~/Documents/radio2.pls >/dev/null 2>&1 &'

# Completions
type talosctl &>/dev/null && . <(talosctl completion bash)

# Functions

# shellcheck disable=SC2164
mkcd() {
	mkdir -p "$@" && cd "$@";
}

git-tag-and-push() {
  git tag "$1"
  git push origin "$1"
}

if [[ -n "${DOTFILES_START_KUBIE_SUBSHELL_IMMEDIATELY}" ]] && type kubie &>/dev/null
then
  # Spawn a new kubie subshell, so there is no mixing between pre-and post kubie shell history.
  # There doesn't seem to be a native way to do this [1]. The con of this is that you always need to
  # exit twice, on leaving the shell.
  # [1] https://github.com/sbstp/kubie/issues/371
  kubie ctx jarvis
fi

if [[ -n $(chezmoi status) ]]
then
  echo
  echo DOTFILES: your dotfiles are NOT up to date, see below for the status
  chezmoi status |pr -to 4
fi

if [[ -n $(git -C $(chezmoi source-path) status -s) ]]
then
  echo
  echo 'DOTFILES: your dotfiles (git repo) has pending changes, see below for the status'
  git -C $(chezmoi source-path) status -s |pr -to 4
fi
